<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Connect Bank Account | Personal Finance Analyzer</title>
  <link rel="stylesheet" href="css/navbar.css" />
  <script src="js/auth.js"></script>

  <!-- Ensure Plaid Script Loads First -->
  <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>

  <style>
    body {
      margin: 0;
      font-family: sans-serif;
    }
    .container {
      display: flex;
      height: calc(100vh - 60px);
    }
    .left-section {
      flex: 1;
      background: url('images/building-login.JPG') center center no-repeat;
      background-size: cover;
    }
    .right-section {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      padding: 2rem;
    }
    button {
      padding: 0.75rem 1.5rem;
      background-color: #333;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar">
    <div class="navbar-left">
      <a href="#" class="navbar-brand">Personal Finance Analyzer</a>
      <ul class="nav-links">
        <li><a href="plaid.html">Link Bank Account</a></li>
        <li><a href="dashboard.html">Home</a></li>
        <li><a href="subscriptions.html">Subscriptions</a></li>
        <li><a href="spending-reports.html">Spending Reports</a></li>
        <li><a href="budgeting.html">Budgeting Tool</a></li>
      </ul>
    </div>
    <div class="navbar-right">
      <a href="feedback.html" class="feedback-link">Send Feedback</a>
    </div>
  </nav>

  <div class="container">
    <div class="left-section">
      <!-- Background image -->
    </div>
    <div class="right-section">
      <h2>Connect Your Bank Account</h2>
      <button id="linkButton">Connect Bank Account</button>
    </div>
  </div>

  <!-- ✅ Updated Plaid JavaScript -->
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      
      async function createLinkToken() {
        try {
          const response = await fetch("http://localhost:5000/api/plaid/create_link_token"); // ✅ Updated API URL
          const data = await response.json();
          return data.link_token;
        } catch (error) {
          console.error("Error creating Plaid link token:", error);
          alert("Failed to connect to Plaid. Check console for errors.");
        }
      }

      async function fetchTransactions(access_token) {
        try {
          const response = await fetch("http://localhost:5000/api/plaid/get_transactions", { // ✅ Updated API URL
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ access_token })
          });
          const data = await response.json();
          console.log("Transactions:", data.transactions);
          alert("Transactions fetched! Check the console.");
        } catch (error) {
          console.error("Error fetching transactions:", error);
          alert("Failed to fetch transactions.");
        }
      }

      async function handlePlaidButtonClick() {
        const linkToken = await createLinkToken();
        if (!linkToken) {
          alert("Could not generate a link token. Please try again.");
          return;
        }

        const handler = Plaid.create({
          token: linkToken,
          onSuccess: async function(public_token) {
            console.log("Public Token:", public_token);
            
            try {
              // ✅ Exchange public token for access token
              const exchangeResponse = await fetch("http://localhost:5000/api/plaid/exchange_public_token", { 
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ public_token })
              });
              const exchangeData = await exchangeResponse.json();

              console.log("Access Token:", exchangeData.access_token);
              if (exchangeData.access_token) {
                await fetchTransactions(exchangeData.access_token);
              } else {
                alert("Failed to get access token.");
              }
            } catch (error) {
              console.error("Error exchanging public token:", error);
              alert("Failed to exchange public token.");
            }
          }
        });

        handler.open();
      }

      document.getElementById("linkButton").addEventListener("click", handlePlaidButtonClick);
    });
  </script>
</body>
</html>
